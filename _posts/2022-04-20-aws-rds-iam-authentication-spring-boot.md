---
layout: post
authors: [yolan_vloeberghs]
title: 'RDS IAM Authentication with Spring Boot - passwordless database authentication on AWS'
image: /img/20211101-postgres-ai/logo-resized.png
tags: [Spring Boot, AWS, Spring]
category: Cloud
comments: true
---

- [Introduction](#introduction)

## Introduction
Database authentication in Spring Boot has traditionally always been very simple to implement and configure to your needs.
Whether it is with a custom data source, or just using the `spring.datasource` properties, it was always pretty straight out-of-the-box to get a working database connection.
Handling the sensitive data such as database passwords in different environments can be tricky, but nowadays there are enough solutions to do this in a secure and discrete way.

However, if you are deploying your application on the AWS cloud, you don't have to struggle with your password.
You are now able to establish a database connection by authenticating with IAM. Note that this feature only works for MariaDB, MySQL and PostgreSQL. 

The feature works with "authentication tokens", which is a string of characters that is unique and generated by Amazon RDS.
One authentication token has a lifespan of 15 minutes and needs to be re-generated before or after it expires to keep the connection alive.

Note that you need to explicitly [enable IAM authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Enabling.html){:target="_blank" rel="noopener noreferrer"} before you can use this feature.

## AWS
The application can only fetch a new authentication token if it has the right to do so.
Since we are running our application on an AWS environment, it only makes sense to make use of IAM roles.
If you are running your application on an EC2 instance, make sure that your EC2 instance has an IAM role attached to it which explicitly gives access to the `rds-db:connect` action.

```json
{
   "Version": "2012-10-17",
   "Statement": [
      {
         "Effect": "Allow",
         "Action": [
             "rds-db:connect"
         ],
         "Resource": [
             "arn:aws:rds-db:region:account-id:dbuser:DbiResourceId/db-user-name"
         ]
      }
   ]
}
```

## Spring Boot
To achieve the token fetching in Spring Boot, I created a custom `HikariDataSource` which overrides the `getPassword()` method and used the AWS Java SDK to create a request for an authentication token from RDS.

```java
public class RdsIAMDataSource extends HikariDataSource {
    @Override
    public String getPassword() {
        RdsIamAuthTokenGenerator authTokenGenerator = RdsIamAuthTokenGenerator.builder()
                .credentials(new DefaultAWSCredentialsProviderChain())
                .region(new DefaultAwsRegionProviderChain().getRegion())
                .build();

        URI jdbcUri = parseJdbcURL(getJdbcUrl());

        GetIamAuthTokenRequest iamAuthTokenRequest = GetIamAuthTokenRequest.builder()
                .hostname(jdbcUri.getHost())
                .port(jdbcUri.getPort())
                .userName(getUsername())
                .build();

        return authTokenGenerator.getAuthToken(iamAuthTokenRequest);
    }

    private URI parseJdbcURL(String jdbcUrl) {
        String uri = jdbcUrl.substring(5);
        return URI.create(uri);
    }
}
```

