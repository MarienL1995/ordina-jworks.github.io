---
layout: post
authors: [jeroen_meys]
title: 'Passwordless on the web with WebAuthn'
image: /img/webauthn/webauthn.jpg
tags: [Security, OAuth, OIDC, Keycloak]
category: Security
comments: true
---
> IT people often blame users for having weak passwords, writing them down and reusing them.
> But I disagree. 
> We provided a sub-par mechanism for authentication and expect them to make the best of it.
> But what if I told you there are other ways?

# Why passwords s*ck
The concept of passwords is build on a shared secret (the password).
We trust the application with our secret and expect it to keep this a secret.
It's true that this password can be hashed, but even then we don't know for sure.
What happens if there is a man-in-the-middle?
We still send our plaintext password to some other party and hope for the best.

Most people I know don't use a password manager yet and tend to reuse old passwords.
This means that if one of the websites you are registered to is compromised, all others can be accessed with it as well.
We taught our users on how to come up with a safe password but they were all of them deceived, for no other secret was made. 
It's one password to rule them all.

But hey, you don't reuse passwords and at work your password even expires every 90 days so you're safe. 
Right?
Fact is that humans tend to be [not so creative](https://en.wikipedia.org/wiki/List_of_the_most_common_passwords) when it comes to passwords.
Does the following scenario sound familiar to you?

When you are asked for a new password, you try this secure base-password, let's say `thisIsMyP@ssword`.
But you want it to be different for every website you register to. So for Twitter it goes `thisIsMyP@ssword_twitter` and on facebook it's `thisIsMyP@ssword_fb`.
Now let's assume one of the sites you registered to (abcde.com) leaks your password and it shows `thisIsMyP@ssword_abcde`.
How confident are you still about your Amazon credentials? 
Or Gmail?

And at work they might even prevent you from reusing old passwords.
This means that `thisIsMyP@ssword01` becomes `thisIsMyP@ssword02`.
This implies that you can never go on a holiday or the following scenario will happen:

* Sit down at desk
* Start laptop to be presented with login screen
* type `thisIsMyP@ssword` and hesitate for a moment
* Think: "Which number was I using before slurping those cocktails on the beach?"
* Go to the helpdesk to have your password reset
* Require a new holiday

<!-- TODO: haveibeenpwned -->

# Multi Factor Authentication
We started to realise that passwords were unsecure but we had no easy alternative.
Second login factors were added to provide additional security.
Think of codes that are send to your smartphone or authenticator apps that required.
A big problem here was the support or the lack thereof.

# WebAuthn
Web Authentication or WebAuthn for short, is a new protocol that introduces a better mechanism for logging in on the web.
Together with the second version of the Client To Authenticator Protocol (CTAP2), this makes up the FIDO2 project.

WebAuthn makes securely logging in to a website, let's say on your phone, as easy as tapping your finger.
It doesn't happen very often that a measure to increase security also improves usability, but this is definitely one of those times.

The project is based on public key cryptography and is backed by the W3C and the FIDO Alliance, which gives it huge support.
And yes, it's supported on all major browser like Google Chrome, Mozilla Firefox and Microsoft Edge.
I did however encounter a problem with Safari where no popups were shown when using a Yubikey.

# Account recovery
When your authenticator is stolen or compromised, it can be tricky to recover your account.
The easiest solution is to enrol multiple authenticators per account.
This removes the need for a recovery mechanism as you can simply use another authenticator to login and remove the obsolete one.
For many users, this won't be a valid route as they don't want to buy and register an extra authenticator.
The second best solution for now is to have a reset mechanism via email.
The biggest issue in a passwordless world is that this mail might also only be accessible via the same - lost - authenticator.
So for key accounts, there should be more than one authenticator or rescue-mechanism in place.
Whatever solution you choose, please don't fall back into a recovery flow with a password.

# How to migrate
We won't be able to migrate to passwordless technologies overnight.
Microsoft suggest to have a transition period where there exist passwordless logins next to the old password flows.
As a next step, hide the password flows from the users but hold on to the support for them.
Only when the transition is complete, the passwords can be deleted.
Being able to revert, gives confidence while showing of the power of passwordless logins.

# An Example With Keycloak
Keycloak released basic support for WebAuthn with its 8.0.0 release.
It's still a bit rough around the edges but overall, the functionality works.
Let's dive in:

Log in on the the Keycloak console and head to Authentication.
You can see there is a new tab named 'WebAuthn Policy'.
Here, the Relying Party settings can be defined.

<span class="image left"><img class="p-image" alt="Webauthn Keycloak Settings" src="{{ '/img/webauthn/policy.png' | prepend: site.baseurl }}"></span>

The only required setting is the RP name. this should be the URL of the website. 
My example is running on https://auth.meys.io but Keycloak happily accepts meys.io.  
This is because SSL is required and meys.io can be used for all subdomains (*.meys.io). The reverse isn't true.
Some other interesting settings are:
* User Verification Requirement: do we want to user to provide some PIN or biometric to prove we are talking to a human?
* Authenticator Attachment: do we allow external authenticators like Yubikeys (cross-platform) or built-in ones like TPMs, Windows Hello or Apple's Touch ID (platform).
* Attestation Preference: do we want extra data about the authenticator? This can help detect rogue authenticators but not everyone will want to give this data (the user has to allow this via a popup).
* Timeout: How much time do we give the user to perform the authentication? Typically this is set to 60 seconds.

> Tip: The spec defines the timeout to be declared in milliseconds. In the Keycloak interface however, the value is in seconds.

If we now try to log in, we still don't see anything WebAuthn related. This is because the standard Browser flow has to be adjusted for it.
Navigate to 'Flows' under Authentication.
When we take a look at the Browser flow, we can see the Username Password Form.
We will have to adjust this so we can use our authenticators.
Editing the current Browser flow is not flexible enough, so let's create a copy in the right upper corner.
Instructions on how to adjust the flow can be found in the [Keycloak documentation](https://www.keycloak.org/docs/latest/server_admin/#creating-a-password-less-browser-login-flow){:target="_blank" rel="noopener noreferrer"}
It takes some tinkering, but you should end up with a result like this:

// TODO: image new flow

Keycloak will still use the default Browser flow, so head over to the Bindings tab, right next to the Flows tab.
Change the Browser flow to the one you just created.

For existing users, we could add a required action that would prompt then to register an authenticator after login in.
But since we want all our users to switch to Webauthn, it's best to make it a required action by default.
Make sure Webauthn Register is checked as default under the next tab 'Required Actions'.

// TODO: image Webauthn Register DEFAULT chechbox

We can now try the flow.
Register a new user via the register flow.
The registration form is still the same.
But once we continue to the next screen, we get a pop-up asking for an authenticator.

// TODO: image

Depending on your chosen Relying Party settings earlier on, you will be prompted for a PIN (User Verification Requirement) and possibly to reveal some authenticator data (Attestation Conveyance Preference).
If all went well, you can now log in with your associated authenticator.

When we now log in again, we should be prompted for a password.
Change the dropdown from Password to WebAuthn and we should see our registered authenticator in the list.

// TODO: image

Hit Log In and we see another popup to tap our authenticator.
Congratulations! 
You are now logged in without using a password.

# Adding a Second Authenticator
The Webauthn required action can be added again to a user account to add a second authenticator.
Try to use a phone for instance to make use of it's platform authenticator.

<div style="text-align: center;" >
    <img class="image fit-contain" src="{{ '/img/webauthn/mobile-1.jpg' | prepend: site.baseurl }}" alt="" width="60%" />
</div>

<hr>

<div style="text-align: center;" >
    <img class="image left" src="{{ '/img/webauthn/mobile-1.jpg' | prepend: site.baseurl }}" alt="" />
    <img class="image" src="{{ '/img/webauthn/mobile-2.jpg' | prepend: site.baseurl }}" alt="" />
    <img class="image right" src="{{ '/img/webauthn/mobile-3.jpg' | prepend: site.baseurl }}" alt="" />
</div>

We now have 2 authenticators linked to the account. 
This means that if I lose one of my authenticators, I can still log in using the other one.
